<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SIRIN MUSEUM - จัดการอุปกรณ์</title>
    <link rel="stylesheet" href="../../assets/css/sidebar.css" />
    <link rel="stylesheet" href="../../assets/css/visitor-register.css" />
    <link rel="stylesheet" href="../../assets/css/manage_device.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <!-- เพิ่ม Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>
    <div class="dashboard-layout active">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>SIRIN MUSEUM</h2>
                <div class="role">STAFF</div>
            </div>

            <div class="user-profile">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-name" id="profileName">เจ้าหน้าที่</div>
                <div class="profile-role" id="profileRole">เจ้าหน้าที่พิพิธภัณฑ์</div>
                <div class="profile-time" id="sidebarLoginTime">เข้าสู่ระบบ: --:--</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link" href="visitor-register.html">
                        <i class="bi bi-person-plus"></i> ลงทะเบียนผู้เยี่ยมชม
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="register-device.html">
                        <i class="bi bi-router"></i> ลงทะเบียนอุปกรณ์
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="manage-device.html">
                        <i class="bi bi-tools"></i> จัดการอุปกรณ์
                    </a>
                </li>
            </ul>

            <button class="logout-btn" onclick="logout()">ออกจากระบบ</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Content Header -->
            <div class="content-header">
                <div class="content-left">
                    <h1>จัดการอุปกรณ์</h1>
                    <p>ค้นหาและจัดการการคืนอุปกรณ์ผู้เยี่ยมชม</p>
                </div>
            </div>

            <!-- Dashboard Stats -->
            <div class="dashboard-grid">
                <!-- Tag ที่ใช้งานทั้งหมด -->
                <div class="card totalRegister-card dashboard-filter" data-filter="registered">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="bi bi-journal-check"></i>
                        </div>
                        <h3 class="card-title">Tag ที่ลงทะเบียนทั้งหมด</h3>
                    </div>
                    <div class="stat-number" id="totalRegisterCount">0</div>
                    <div class="stat-label">ชุด</div>
                </div>

                <!-- Tag ที่ใช้งานทั้งหมด -->
                <div class="card total-card dashboard-filter" data-filter="in_use">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="bi bi-bar-chart"></i>
                        </div>
                        <h3 class="card-title">Tag ที่ใช้งานทั้งหมด</h3>
                    </div>
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">ชุด</div>
                </div>

                <!-- คืนแล้ว -->
                <div class="card returned-card dashboard-filter" data-filter="returned">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <h3 class="card-title">คืนแล้ว</h3>
                    </div>
                    <div class="stat-number" id="returnedCount">0</div>
                    <div class="stat-label">ชุด</div>
                </div>

                <!-- ยังไม่คืน -->
                <div class="card active-card dashboard-filter" data-filter="not_returned">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <h3 class="card-title">ยังไม่คืน</h3>
                    </div>
                    <div class="stat-number" id="activeCount">0</div>
                    <div class="stat-label">ชุด</div>
                </div>
            </div>

            <!-- Search Form -->
            <div class="form-container">
                <h2 style="margin-bottom: 20px; color: #2a8c78;">
                    <i class="bi bi-search" style="margin-right: 10px;"></i>
                    ค้นหาผู้เยี่ยมชมเพื่อคืนอุปกรณ์
                </h2>

                <div class="form-grid">
                    <!-- Dropdown: ค้นหาจาก -->
                    <div class="form-group">
                        <label for="searchType">
                            <i class="bi bi-funnel" style="margin-right: 5px;"></i>
                            ค้นหาจาก
                        </label>
                        <select id="searchType">
                            <option value="name">ชื่อ-นามสกุล</option>
                            <option value="beacon">iBeacon Tag</option>
                            <option value="group">ชื่อกลุ่ม</option>
                        </select>
                    </div>

                    <!-- กล่องกรอกคำค้น -->
                    <div class="form-group">
                        <label for="searchValue">
                            <i class="bi bi-search" style="margin-right: 5px;"></i>
                            ค้นหา
                        </label>
                        <input type="text" id="searchValue" list="visitorList" placeholder="กรอกข้อมูลที่ต้องการค้นหา">
                        <datalist id="visitorList"></datalist>
                    </div>
                </div>

                <!-- ปุ่มค้นหา -->
                <button class="btn" onclick="searchVisitors()">
                    <i class="bi bi-search" style="margin-right: 8px;"></i>
                    ค้นหา
                </button>
            </div>

            <!-- Device Table -->
            <div class="table-container">
                <!-- Filter Bar (แก้ไขให้เหมือน visitor-register.html) -->
                <div class="filter-bar">
                    <i class="bi bi-filter" style="margin-right: 8px; color: #2a8c78;"></i>
                    <label for="deviceTypeFilter">แสดง</label>
                    <select id="deviceTypeFilter">
                        <option value="all">All</option>
                        <option value="available">Available</option>
                        <option value="success">Success</option>
                        <option value="damaged">Damaged</option>
                    </select>
                </div>

                <!-- Table -->
                <table class="table">
                    <thead id="deviceTableHead">
                        <tr>
                            <th><i class="bi bi-hash" style="margin-right: 5px;"></i>ลำดับ</th>
                            <th><i class="bi bi-person" style="margin-right: 5px;"></i>ชื่อ-นามสกุล</th>
                            <th><i class="bi bi-broadcast" style="margin-right: 5px;"></i>iBeacon</th>
                            <th><i class="bi bi-people" style="margin-right: 5px;"></i>กลุ่ม</th>
                            <th><i class="bi bi-calendar" style="margin-right: 5px;"></i>วันที่เยี่ยมชม</th>
                            <th><i class="bi bi-clock" style="margin-right: 5px;"></i>เวลา</th>
                            <th><i class="bi bi-info-circle" style="margin-right: 5px;"></i>สถานะ</th>
                            <th><i class="bi bi-gear" style="margin-right: 5px;"></i>การจัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <tr>
                            <td colspan="8" class="no-data">
                                <i class="bi bi-hourglass-split" style="margin-right: 8px;"></i>
                                กำลังโหลดข้อมูล...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../../assets/js/manage-device.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            applyDeviceFilter();

            // ✅ รีเซ็ต datalist เมื่อเปลี่ยนประเภทการค้นหา
            document.getElementById('searchType').addEventListener('change', () => {
                document.getElementById('searchValue').value = '';
                document.getElementById('visitorList').innerHTML = '';
            });
        });

        // ✅ Event: พิมพ์แล้วโหลด suggestion
        document.getElementById('searchValue').addEventListener('input', e => {
            if (e.target.value.length > 1) updateDatalist(e.target.value);
        });

        document.getElementById('searchValue').addEventListener('input', e => {
            console.log("กำลังโหลดคำแนะนำ", e.target.value); // DEBUG
            if (e.target.value.length > 1) updateDatalist(e.target.value);
        });

        document.getElementById('searchValue').addEventListener('input', e => {
            const value = e.target.value.trim();
            if (value === "") {
                // โหลดข้อมูลทั้งหมดเมื่อช่องค้นหาว่าง
                applyDeviceFilter();
            }
        });
    </script>
</body>

</html>